{% extends 'layout.html' %}

{% block content %}
  <!-- ë¡œê·¸ì•„ì›ƒ ë©”ì‹œì§€ í‘œì‹œ -->
  {% if request.query.message %}
    <div class="mb-6">
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative">
        <span class="block sm:inline">{{ request.query.message }}</span>
        <button class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
          <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
            <title>Close</title>
            <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 0 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 0 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
          </svg>
        </button>
      </div>
    </div>
  {% endif %}
  
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900">ğŸ·ï¸ ê²½ë§¤ ì§„í–‰ ëª©ë¡</h2>
      <p class="mt-1 text-sm text-gray-600">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ ìƒí’ˆë“¤ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒí’ˆëª…</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ë¯¸ì§€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹œì‘ ê°€ê²©</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì¢…ë£Œ ì‹œê°„</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì…ì¥</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for good in goods %}
            <tr class="hover:bg-gray-50 transition duration-150">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{good.name}}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex-shrink-0 h-20 w-20">
                  <img class="h-20 w-20 rounded-lg object-cover border border-gray-200" 
                       src="/img/{{good.img}}" 
                       onerror="this.src='/default-image.svg'; this.onerror=null;" 
                       alt="{{good.name}}">
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-bold text-green-600">{{good.price}}ì›</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-mono bg-yellow-100 px-3 py-1 rounded-full time" 
                     data-start="{{good.createdAt}}">00:00:00</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <a href="/good/{{good.id}}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                  </svg>
                  ì…ì¥
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if goods|length == 0 %}
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4m0 0L4 7m16 0v10l-8 4m0 0l-8-4m8 4V3"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">ê²½ë§¤ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="mt-1 text-sm text-gray-500">ìƒˆë¡œìš´ ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
      </div>
    {% endif %}
  </div>
  
  <script src="https://unpkg.com/event-source-polyfill/src/eventsource.min.js"></script>
  <script>
    // ê²½ë§¤ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
    function updateAuctionTimes() {
      document.querySelectorAll('.time').forEach((td) => {
        const startTime = new Date(td.dataset.start);
        const endTime = new Date(startTime);
        endTime.setDate(endTime.getDate() + 1); // 24ì‹œê°„ í›„
        
        const now = new Date();
        const remaining = endTime - now;
        
        if (remaining <= 0) {
          // ê²½ë§¤ ì¢…ë£Œ
          td.textContent = '00:00:00';
          td.classList.remove('bg-yellow-100', 'text-gray-900', 'bg-orange-100', 'text-orange-600');
          td.classList.add('bg-red-100', 'text-red-600');
          
          // ì…ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
          const enterBtn = td.closest('tr').querySelector('.enter');
          if (enterBtn) {
            enterBtn.classList.add('opacity-50', 'cursor-not-allowed');
            enterBtn.onclick = (e) => {
              e.preventDefault();
              alert('ì´ ê²½ë§¤ëŠ” ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
          }
        } else {
          // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
          const hours = Math.floor(remaining / (1000 * 60 * 60));
          const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
          
          td.textContent = 
            ('0' + hours).slice(-2) + ':' + 
            ('0' + minutes).slice(-2) + ':' + 
            ('0' + seconds).slice(-2);
          
          // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
          if (remaining < 60000) { // 1ë¶„ ë¯¸ë§Œ
            td.classList.remove('bg-yellow-100', 'text-gray-900', 'bg-orange-100', 'text-orange-600');
            td.classList.add('bg-red-100', 'text-red-600');
          } else if (remaining < 300000) { // 5ë¶„ ë¯¸ë§Œ
            td.classList.remove('bg-yellow-100', 'text-gray-900', 'bg-red-100', 'text-red-600');
            td.classList.add('bg-orange-100', 'text-orange-600');
          } else {
            td.classList.remove('bg-red-100', 'text-red-600', 'bg-orange-100', 'text-orange-600');
            td.classList.add('bg-yellow-100', 'text-gray-900');
          }
        }
      });
    }
    
    // ì´ˆê¸° ì‹œê°„ ê³„ì‚°
    updateAuctionTimes();
    
    // SSEë¡œ ì„œë²„ ì‹œê°„ ë™ê¸°í™”
    const es = new EventSource('/sse');
    es.onmessage = function (e) {
      updateAuctionTimes();
    };
    
    // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
    setInterval(updateAuctionTimes, 1000);
  </script>
{% endblock %}
